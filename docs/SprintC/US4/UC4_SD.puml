@startuml
autonumber
actor "Receptionist" as REC

participant ":CreateTestUI" as UI
participant ":CreateTestController" as CTRL
participant "comp\n:Company" as COMP

participant "testStore: TestStore" as TSTORE

participant "store: ClientStore" as CSTORE

participant "storeTypeOfTest: TypeOfTestStore" as TTSTORE

participant "test\n:Test" as TEST
participant "testDto: TestDto" as TDTO
participant "typeOfTestMap:TypeOfTestMapper" as TTMAPPER

participant "parameterMap:ParameterMapper" as PMAPPER
participant "storeParameter: ParameterStore" as PSTORE


activate REC
REC -> UI : start the creation of a new test
activate UI
UI --> REC : Asks to select a registered client
deactivate UI
REC -> UI : Select one client
activate UI
UI -> CTRL : addClient(**testDto**)
activate CTRL

CTRL -> COMP : cliStore = getClientStore()
activate COMP
deactivate COMP
CTRL -> TDTO : citizenCardNumber = getCitizenCardNumber()
activate TDTO
deactivate TDTO
CTRL -> CSTORE : client = getClientByCitizenCard(citizenCardNumber)
activate CSTORE
deactivate CSTORE


CTRL -> COMP : ttStore = getTypeOfTestStore()
activate COMP
deactivate COMP

deactivate TSTORE
deactivate TEST


CTRL -> TTSTORE : ttList=getTypeOfTestList()
activate TTSTORE
deactivate TTSTORE
CTRL -> TMAPPER** : toDTO(ttList)

activate TMAPPER
ref over TMAPPER
  SD_TypeOfTestMapper_toDTO_list
end ref


TMAPPER --> CTRL : typeOfTestListDto
deactivate TMAPPER
CTRL --> UI : typeOfTestListDto
deactivate CTRL
deactivate CSTORE
UI --> REC: shows type of test list
deactivate CTRL
deactivate UI

REC -> UI : choose a type of test
activate UI

UI -> CTRL : addTypeOfTest(typeOfTestId)
activate CTRL
CTRL -> TTSTORE : typeOfTest = getTypeOfTestById(typeOfTestId)
activate TTSTORE
deactivate TTSTORE

deactivate TSTORE
deactivate TEST

CTRL -> TTSTORE : categoryList = getCategoryListByTypeOfTest(typeOfTest)

activate TTSTORE
deactivate TTSTORE

CTRL -> PMAPPER** : toDTO(categoryList)
activate PMAPPER

ref over PMAPPER
  SD_ParameterMapper_toDTO_list
end ref


PMAPPER --> CTRL : listParameterDto
deactivate PMAPPER
CTRL --> UI : listParameterDto
deactivate CTRL
UI --> REC : show parameters list
deactivate UI

REC -> UI :  selects one parameter category
activate UI
UI -> CTRL : createTest(pcId)
activate CTRL
CTRL -> COMP : testStore = getTestStore()
activate COMP
deactivate COMP

CTRL -> TSTORE : test = createTest(client, testType, pcId)

activate TSTORE
  TSTORE -> TEST** : create(client, testType, pcId)
  activate TEST
  TEST -> TESTDTO : nhsCode = getNhsCode()
deactivate TEST

deactivate TSTORE
  CTRL -> TSTORE : validateTest(test)
activate TSTORE
deactivate TSTORE
deactivate CTRL
UI -> REC : shows parameter categories to select other (if intended)
deactivate UI

loop [for any intended parameter category]

  REC -> UI : choose a parameter
  activate UI
  UI -> CTRL : addParameter(parameterId)
  activate CTRL
  CTRL -> PSTORE : parameter = getParameterById(parameterId)
  activate PSTORE
  deactivate PSTORE
    CTRL -> TEST : addParameter(parameter)
    activate TEST
    deactivate TEST

  CTRL --> UI : ok
  UI -> REC : added with success

end

UI --> REC : shows all data and request confirmation
deactivate UI
deactivate CTRL
  REC -> UI : confirms the data
activate UI
  UI -> CTRL : saveTest()
activate CTRL


  CTRL -> TSTORE : saveTest(test)
  activate TSTORE
  TSTORE -> TSTORE : validateTest(test)
  TSTORE -> TSTORE : addTest(test)

  TSTORE --> CTRL : test added

deactivate TSTORE
  CTRL --> UI: result
deactivate CTRL

UI --> REC : informs operation success
deactivate COMP
deactivate CTRL
deactivate UI
deactivate REC
@enduml
